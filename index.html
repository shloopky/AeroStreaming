const SB_URL = 'https://nrpiojdaltgfgswvhrys.supabase.co'; 
const SB_KEY = 'sb_publishable_nu-if7EcpRJkKD9bXM97Rg__X3ELLW7';
const _supabase = supabase.createClient(SB_URL, SB_KEY);

let currentUser = null;
let isLoginMode = false;
let selectedFile = null;

// --- VIEW CONTROLLER ---
function setView(view) {
    const content = document.getElementById('sidebar-content');
    const header = document.getElementById('sidebar-header');
    content.innerHTML = ''; // Clear current list
    
    document.querySelectorAll('.server-icon').forEach(el => el.classList.remove('active'));

    if (view === 'dm') {
        document.getElementById('nav-dm').classList.add('active');
        header.innerText = "Direct Messages";
        loadFriendsList(); 
    } else if (view === 'friends') {
        document.getElementById('nav-friends').classList.add('active');
        header.innerText = "Friends Management";
        renderFriendsUI(); 
    }
}

// --- PROFILE LOGIC ---
function openProfile() {
    document.getElementById('profile-modal').style.display = 'flex';
    document.getElementById('edit-username').value = document.getElementById('my-name').innerText;
}

function closeProfile() {
    document.getElementById('profile-modal').style.display = 'none';
    selectedFile = null;
}

// Drag & Drop Setup
const dropZone = document.getElementById('drop-zone');
const fileInput = document.getElementById('file-input');
if(dropZone) {
    dropZone.onclick = () => fileInput.click();
    dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('dragover'); };
    dropZone.ondragleave = () => dropZone.classList.remove('dragover');
    dropZone.ondrop = (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        handleFiles(e.dataTransfer.files[0]);
    };
    fileInput.onchange = (e) => handleFiles(e.target.files[0]);
}

function handleFiles(file) {
    if (!file || !file.type.startsWith('image/')) return;
    selectedFile = file;
    const reader = new FileReader();
    reader.onload = (e) => {
        document.getElementById('preview-img').src = e.target.result;
        document.getElementById('preview-img').style.display = 'block';
    };
    reader.readAsDataURL(file);
}

async function saveProfile() {
    let pfpUrl = document.getElementById('my-pfp').src;
    const newUsername = document.getElementById('edit-username').value;

    if (selectedFile) {
        const fileName = `${currentUser.id}_avatar.png`;
        const { error } = await _supabase.storage.from('avatars').upload(fileName, selectedFile, { upsert: true });
        if (error) return alert("Upload failed: " + error.message);
        const { data: publicUrl } = _supabase.storage.from('avatars').getPublicUrl(fileName);
        pfpUrl = publicUrl.publicUrl;
    }

    await _supabase.from('profiles').upsert({ id: currentUser.id, username: newUsername, pfp: pfpUrl });
    location.reload(); 
}

// --- FRIENDS LOGIC ---
function renderFriendsUI() {
    const content = document.getElementById('sidebar-content');
    content.innerHTML = `
        <div style="padding: 15px;">
            <input type="text" id="friend-search" placeholder="Username..." class="input-box" style="margin-bottom:10px; background:white;">
            <button class="aero-btn" onclick="sendFriendRequest()">Send Request</button>
        </div>
        <div class="section-label">Pending Requests</div>
        <div id="pending

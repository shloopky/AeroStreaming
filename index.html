<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AeroSocial - Private & Servers</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<div id="auth-overlay" class="overlay" style="display: flex; position: fixed; width: 100%; height: 100%; z-index: 10000; background: rgba(255,255,255,0.8); backdrop-filter: blur(20px); justify-content: center; align-items: center;">
    <div class="auth-card glass-panel" style="padding: 40px; border-radius: 24px; background: white; width: 350px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
        <h2 style="color: #0078d7; text-align: center;">AeroSocial</h2>
        <input type="email" id="email-in" placeholder="Email" style="width:100%; padding:12px; margin-bottom:10px; border-radius:8px; border:1px solid #ddd;">
        <input type="password" id="pass-in" placeholder="Password" style="width:100%; padding:12px; margin-bottom:10px; border-radius:8px; border:1px solid #ddd;">
        <input type="text" id="username-in" placeholder="Display Name" style="width:100%; padding:12px; margin-bottom:10px; border-radius:8px; border:1px solid #ddd;">
        <input type="text" id="bio-in" placeholder="Your Bio" style="width:100%; padding:12px; margin-bottom:20px; border-radius:8px; border:1px solid #ddd;">
        <button class="aero-btn" onclick="handleSignUp()" style="width: 100%; margin-bottom: 10px;">Sign Up</button>
        <button class="aero-btn" onclick="handleLogin()" style="width: 100%; background: #555;">Login</button>
    </div>
</div>

<div id="profile-modal" class="profile-card" style="display:none;">
    <img id="view-pfp" src="" class="profile-pfp-large">
    <h3 id="view-user">Username</h3>
    <p id="view-bio" class="bio-text">No bio yet.</p>
    <button class="aero-btn" onclick="closeProfile()" style="width: 100%;">Close</button>
</div>

<nav class="server-rail">
    <div class="server-icon active" onclick="showDMs()">✉️</div>
    <hr style="width:30px; opacity:0.2;">
    <div id="server-list"></div>
    <div class="server-icon" onclick="createServer()" style="color: green;">+</div>
</nav>

<aside class="sub-sidebar">
    <div id="sidebar-header" style="padding: 20px; font-weight: 800; font-size: 18px; color: #0078d7;">Direct Messages</div>
    
    <div id="sidebar-content">
        </div>

    <div style="margin-top:auto; padding: 15px; display:flex; align-items:center; gap:10px; background: rgba(0,0,0,0.03);">
        <img id="my-pfp" src="https://via.placeholder.com/32" class="pfp-img" style="cursor:pointer;" onclick="showOwnProfile()">
        <span id="my-name" style="font-size: 13px; font-weight: 600;">Account</span>
    </div>
</aside>

<main class="chat-window">
    <div id="chat-messages"></div>
    <div class="input-area">
        <input type="text" id="chat-in" class="input-box" placeholder="Say something..." onkeypress="if(event.key==='Enter') sendMessage()">
    </div>
</main>

<script>
    const _supabase = supabase.createClient('YOUR_URL', 'YOUR_KEY');

    let currentUser = null;
    let currentMode = 'dm'; // 'dm' or 'server'
    let activeChatID = null;

    // --- AUTH ---
    async function handleSignUp() {
        const email = document.getElementById('email-in').value;
        const password = document.getElementById('pass-in').value;
        const username = document.getElementById('username-in').value;
        const bio = document.getElementById('bio-in').value;

        const { data, error } = await _supabase.auth.signUp({ email, password });
        if (data.user) {
            // Save extra info to a 'profiles' table
            await _supabase.from('profiles').insert([{ id: data.user.id, username, bio, pfp: 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + username }]);
            alert("Sign up successful! Please login.");
        }
    }

    async function handleLogin() {
        const email = document.getElementById('email-in').value;
        const password = document.getElementById('pass-in').value;
        const { data, error } = await _supabase.auth.signInWithPassword({ email, password });
        if (data.user) location.reload();
    }

    // --- NAVIGATION ---
    function showDMs() {
        currentMode = 'dm';
        document.getElementById('sidebar-header').innerText = "Direct Messages";
        renderDMSidebar();
    }

    function renderDMSidebar() {
        const cont = document.getElementById('sidebar-content');
        cont.innerHTML = `<div class="section-label">Friends</div>`;
        // Load friend list logic here
    }

    async function switchServer(serverID, serverName) {
        currentMode = 'server';
        activeChatID = serverID;
        document.getElementById('sidebar-header').innerText = serverName;
        
        const cont = document.getElementById('sidebar-content');
        cont.innerHTML = `
            <div class="section-label">Channels</div>
            <div class="channel-item active" onclick="setChannel('gen1')"># general-1</div>
            <div class="channel-item" onclick="setChannel('gen2')"># general-2</div>
        `;
        loadMessages();
    }

    // --- PROFILE SYSTEM ---
    async function showOwnProfile() {
        const { data } = await _supabase.from('profiles').select('*').eq('id', currentUser.id).single();
        document.getElementById('view-user').innerText = data.username;
        document.getElementById('view-bio').innerText = data.bio;
        document.getElementById('view-pfp').src = data.pfp;
        document.getElementById('profile-modal').style.display = 'block';
    }

    function closeProfile() { document.getElementById('profile-modal').style.display = 'none'; }

    // --- MESSAGE SYSTEM ---
    async function sendMessage() {
        const text = document.getElementById('chat-in').value;
        if (!text) return;

        const { data: prof } = await _supabase.from('profiles').select('*').eq('id', currentUser.id).single();

        await _supabase.from('messages').insert([{
            sender_id: currentUser.id,
            username: prof.username,
            pfp: prof.pfp,
            content: text,
            chat_id: activeChatID, // Can be server_id or dm_id
            mode: currentMode
        }]);
        document.getElementById('chat-in').value = '';
    }

    // Initialize
    window.onload = async () => {
        const { data } = await _supabase.auth.getUser();
        if (data.user) {
            currentUser = data.user;
            document.getElementById('auth-overlay').style.display = 'none';
            showDMs();
        }
    };
</script>
</body>
</html>
</body>
</html>
